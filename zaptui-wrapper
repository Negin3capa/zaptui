#!/bin/bash
set -e

# ZapTUI Global Wrapper
# This script manages the WhatsApp service and launches the TUI
# Can be run from anywhere on the system

# Installation paths
INSTALL_DIR="$HOME/.local/share/zaptui"
SERVICE_DIR="$INSTALL_DIR/whatsapp-service"
AUTH_DIR="$INSTALL_DIR/.wwebjs_auth"
BINARY="$INSTALL_DIR/zaptui-bin"

# Handle info flags directly without starting service
if [[ "$1" == "--version" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]] || [[ "$1" == "-V" ]]; then
    if [ -f "$BINARY" ]; then
        exec "$BINARY" "$@"
    else
        echo "âŒ ZapTUI not properly installed. Run './install.sh' from the project directory."
        exit 1
    fi
fi

# Check if installation exists
if [ ! -d "$INSTALL_DIR" ]; then
    echo "âŒ ZapTUI not properly installed."
    echo "Run './install.sh' from the project directory to install globally."
    exit 1
fi

if [ ! -f "$BINARY" ]; then
    echo "âŒ ZapTUI binary not found at $BINARY"
    echo "Run './install.sh' from the project directory to reinstall."
    exit 1
fi

echo "ğŸš€ ZapTUI - Starting..."
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Error: Node.js is not installed"
    exit 1
fi

# Check if service dependencies are installed
if [ ! -d "$SERVICE_DIR/node_modules" ]; then
    echo "ğŸ“¦ WhatsApp service dependencies missing. Installing..."
    cd "$SERVICE_DIR"
    npm install --silent
    cd - > /dev/null
fi

# Check if service is already running
SERVICE_ALREADY_RUNNING=false
if lsof -Pi :8080 -sTCP:LISTEN -t > /dev/null 2>&1 ; then
    echo "âœ… WhatsApp service already running (shared)"
    SERVICE_ALREADY_RUNNING=true
fi

# Cleanup function (only cleanup service if we started it)
cleanup() {
    echo ""
    if [ "$SERVICE_ALREADY_RUNNING" = false ]; then
        echo "ğŸ›‘ Stopping WhatsApp service..."
        if [ ! -z "$WA_PID" ]; then
            kill $WA_PID 2>/dev/null || true
        fi
        pkill -f "node.*server.js" 2>/dev/null || true
        sleep 0.5
        if lsof -Pi :8080 -sTCP:LISTEN -t > /dev/null 2>&1; then
            lsof -ti:8080 | xargs kill -9 2>/dev/null || true
        fi
    else
        echo "â„¹ï¸  Leaving shared service running for other instances"
    fi
    echo "âœ… Goodbye!"
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Start WhatsApp Service if not already running
if [ "$SERVICE_ALREADY_RUNNING" = false ]; then
    echo "ğŸ”Œ Starting WhatsApp service..."
    
    # Set auth path via environment variable
    export ZAPTUI_AUTH_PATH="$AUTH_DIR"
    
    cd "$SERVICE_DIR"
    node server.js > /dev/null 2>&1 &
    WA_PID=$!
    cd - > /dev/null
    
    # Wait for service to start
    sleep 2
    if ! kill -0 $WA_PID 2>/dev/null; then
        echo "âŒ Failed to start WhatsApp service"
        exit 1
    fi
    
    echo "âœ… Connected. launching TUI..."
else
    echo "ğŸš€ Launching TUI..."
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run TUI (don't use exec so cleanup trap can run)
"$BINARY" "$@"

# Exit with same code as binary
exit $?
